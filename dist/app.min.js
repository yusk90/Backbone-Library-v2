_.mixin({capitalize:function(e){var i=e.split("-");return i.reduce(function(e,i){return e+i[0].toUpperCase()+i.slice(1)})},hyphen:function(e){return e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}});var app={};!function(e){e.LibraryRouter=Backbone.Router.extend({routes:{"":"indexPage","book/:id":"renderBook"},initialize:function(){},renderBook:function(e){$("#book-form, #library-list").hide()},indexPage:function(){$("#book-form, #library-list").show()}})}(app),function(e){e.BookModel=Backbone.Model.extend({defaults:{book:"",author:"",publishYear:"",publishHouse:"",fullDescription:"",shortDescription:""},validate:function(e){var i={};return e.book||(i.book="Введите название книги."),e.author||(i.author="Введите автора."),e.publishYear||(i.publishYear="Введите год издания."),e.publishHouse||(i.publishHouse="Введите издательство."),e.fullDescription||(i.fullDescription="Введите описание."),_.isEmpty(i)?!1:i}})}(app),function(e){e.LibraryCollection=Backbone.Collection.extend({model:e.BookModel,localStorage:new Backbone.LocalStorage("Library")})}(app),function(e){e.BaseView=Backbone.View.extend({showErrors:function(e,i,t){function o(e,i){this.$("#"+_.hyphen(i)+n).siblings(".book-form__error").html(e)}var n=e?"-"+i.cid:"";_.each(t,o,this)},truncate:function(e){return e.length>140&&(e=e.slice(0,140)+"..."),e},disableElement:function(e,i){var t=this.$(e),o=i?"addClass":"removeClass";t.prop("disabled",i),t[o]("button--disabled")},close:function(){this.remove(),this.unbind()}})}(app),function(e){e.BookView=e.BaseView.extend({tagName:"li",className:"library-list__item",template:_.template($("#single-book-template").html()),events:{"click .delete-book":"deleteBook","click .edit-book":"editBook","click .full-description":""},initialize:function(){this.listenTo(this.model,"change",this.render).listenTo(this,"disable-edit",this.disableElement)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},deleteBook:function(){confirm("Вы действительно хотите удалить книгу?")&&(this.editView&&this.editView.close(),this.close(),this.model.destroy())},editBook:function(){this.editView=new e.EditView({model:this.model}),this.listenTo(this.editView,"disable-edit",this.disableElement),this.$el.append(this.editView.render().el),this.trigger("disable-edit",".edit-book",!0)}})}(app),function(e){e.EditView=e.BaseView.extend({tagName:"form",className:"book-form",id:function(){return"edit-form-"+this.model.cid},template:_.template($("#edit-form-template").html()),events:{"click .submit-edited-book":"submitEditedBook","click .cancel-edit":"cancelEdit"},render:function(){return this.$el.html(this.template(this.model)),_.each(this.model.toJSON(),this.fillEditFields,this),this},fillEditFields:function(e,i){this.$("#"+_.hyphen(i+"-"+this.model.cid)).val(e)},submitEditedBook:function(){function e(e){t[_.capitalize(e.id.replace("-"+o,""))]=e.value}var i=this.$("input, textarea"),t={},o=this.model.cid;Backbone.trigger("clear-errors"),this.listenTo(this.model,"invalid",this.showErrors.bind(this,!0)),_.each(i,e,this),this.model.save(t,{success:function(){this.cancelEdit()}.bind(this)})},cancelEdit:function(){this.trigger("disable-edit",".edit-book",!1),this.close()}})}(app),function(e){e.AppView=e.BaseView.extend({el:"#content",initialize:function(){this.model=new e.BookModel,this.collection=new e.LibraryCollection,this.listenTo(this.collection,"reset",this.addAll).listenTo(this.model,"invalid",this.showErrors.bind(this,!1)).listenTo(Backbone,"clear-errors",this.clearErrors),this.collection.fetch({reset:!0})},events:{"click #submit-book":"submit"},clearErrors:function(){this.$(".book-form__error").html("")},submit:function(){function i(e){o[_.capitalize(e.id)]=e.value}var t=this.$("#book-form input, #book-form textarea"),o={};if(Backbone.trigger("clear-errors"),_.each(t,i,this),this.model.set(o),this.model.isValid()){var n=new e.BookModel;n.set(o),n.set("shortDescription",this.truncate(n.get("fullDescription"))),t.val(""),this.collection.create(n);var s=new e.BookView({model:n});this.$("#library-list").append(s.render().el)}},addAll:function(){function i(i){var o=new e.BookView({model:i});t.append(o.render().el)}var t=$(document.createDocumentFragment());this.collection.each(i,this),this.$("#library-list").append(t)}})}(app),$(function(){new app.LibraryRouter,new app.AppView,Backbone.history.start({})});